---
title: "Explore GLMM models for DNA methylation data"
author: "KE Lotterhos"
date: "9/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install packages

```{r cars}
packages_needed <- c("lme4", "multcomp", "devtools", "car", "MCMCglmm", "brms", "rstan")

for (i in 1:length(packages_needed)){
  if(!(packages_needed[i] %in% installed.packages())){install.packages(packages_needed[i])}
}

for (i in 1:length(packages_needed)){
  library( packages_needed[i], character.only = TRUE)
}
```

## Load data

Katie's working directory for this markdown:
setwd("~/Documents/GitHub/2017OAExp_Oysters/markdown_files/DNAm/exploreBinomModels")

You may have to set a different one.

```{r pressure, echo=FALSE}
mC <- readRDS("data/Final_mC_gene_5.RData")
uC <- readRDS("data/Final_umC_gene_5.RData")
meta_locus <- readRDS("data/Final_meta_gene_5.RData")
meta_samp <- readRDS("data/metadata_20190811.RData")

head(mC)
head(uC)
head(meta_locus)
head(meta_samp)

meta_samp$level <- paste(meta_samp$Treatment, meta_samp$Time, sep="_")

# remove excluded individual
meta_samp <- meta_samp[-which(meta_samp$ID==17099),]

# unit test - these should both be true
identical(names(mC), names(uC))
identical(names(uC), meta_samp$ID)
```

## Create some interesting cases
```{r}
# real data
a <- data.frame(mc=as.numeric(mC[1,]),
           uc=as.numeric(uC[1,]),
           level=meta_samp$level,
           Treatment = meta_samp$Treatment,
           Time = meta_samp$Time,
           tankID = meta_samp$tankID,
            Pop = meta_samp$Pop,
           size = as.numeric(mC[1,])+as.numeric(uC[1,]))

# real data with all 0 for unmeth in one treatment
b <- a
b$uc[b$level=='400_09'] <- 0
b

# real data with all 0 for meth in one treatment
c <- a
c$mc[c$level=='400_09'] <- 0
c

# real data with all one count for meth in one treatment
# compare to c for zero variance
d <- a
d$mc[d$level=='400_09'] <- 1
d$uc[d$level=='400_09'] <- 20
d
```

## Test different models for real data

```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=a, las=2)
# No random effect of tank
m1 <- glm(cbind(mc,uc)~ Treatment*Time, data=a,family = "binomial")
summary(m1)
boxplot(m1$residuals~a$tankID)
boxplot(m1$residuals~a$Pop)
  # definitely some tank effects in the residuals
vif(m1) # variance inflation factor
AIC(m1)

m1.0 <- glm(cbind(mc,uc)~ Treatment*Time, data=a,family = "quasibinomial")
summary(m1.0)
boxplot(m1.0$residuals~a$tankID)
boxplot(m1.0$residuals~a$Pop)
  # definitely some tank effects in the residuals
vif(m1.0) # variance inflation factor

m1.1 <- glmer(cbind(mc,uc)~ Treatment*Time + (1|tankID), data=a,family = "binomial")
summary(m1.1)
boxplot(residuals(m1.1)~a$tankID)
boxplot(residuals(m1.1)~a$Pop)
  # this seems to be better, but still not perfectly accounting for residuals across tanks
vif(m1.1) # the inflation in size of the confidence ellipse or ellipsoid for the coefficients of the term in comparison with what would be obtained for orthogonal data.
AIC(m1.1)
  # improvement in model fit compared to m0
```

## Test different models for fake data "b"
One treatment has 100% methylation in all individuals

```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=b, las=2)

# No random effect of tank
m1 <- glm(cbind(mc,uc)~ Treatment*Time, data=b,family = "binomial")
summary(m1)
boxplot(m1$residuals~b$tankID)
boxplot(m1$residuals~b$Pop)
  # definitely some tank effects in the residuals
vif(m1) # variance inflation factor
  # hmmm

m1.1 <- glmer(cbind(mc,uc)~ Treatment*Time + (1|tankID), data=b,family = "binomial")
summary(m1.1)
boxplot(residuals(m1.1)~b$tankID)
boxplot(residuals(m1.1)~b$Pop)
  # this seems to be better, but we get that strange error message
vif(m1.1) # the inflation in size of the confidence ellipse or ellipsoid for the coefficients of the term in comparison with what would be obtained for orthogonal data.
```

## Test different models for fake data "c"
One treatment has 0% methylation in all individuals
```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=c, las=2)

# No random effect of tank
m1 <- glm(cbind(mc,uc)~ Treatment*Time, data=c,family = "binomial")
summary(m1)
boxplot(m1$residuals~c$tankID)
boxplot(m1$residuals~c$Pop)
  # definitely some tank effects in the residuals
vif(m1) # variance inflation factor
  # hmmm not good

m1.1 <- glmer(cbind(mc,uc)~ Treatment*Time + (1|tankID), data=c,family = "binomial")
summary(m1.1)
boxplot(residuals(m1.1)~c$tankID)
boxplot(residuals(m1.1)~c$Pop)
  # this seems to be better, but we get that strange error message
vif(m1.1) # the inflation in size of the confidence ellipse or ellipsoid for the coefficients of the term in comparison with what would be obtained for orthogonal data.

```


## Test different models for fake data "d"
One treatment has a count of 1 methylation in all individuals. This can be compared to dataset "c" to show the problem comes from fixation of counts of 0 and not from zero variance in a treatment.
```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=d, las=2)

# No random effect of tank
m1 <- glm(cbind(mc,uc)~ Treatment*Time, data=d,family = "binomial")
summary(m1)
boxplot(m1$residuals~d$tankID)
boxplot(m1$residuals~d$Pop)
  # definitely some tank effects in the residuals
vif(m1) # variance inflation factor
  # interesting, much better behaved

m1.1 <- glmer(cbind(mc,uc)~ Treatment*Time + (1|tankID), data=d,family = "binomial")
  # note no error message
summary(m1.1)
boxplot(residuals(m1.1)~d$tankID)
boxplot(residuals(m1.1)~d$Pop)
  # this seems to be better, but we get that strange error message
vif(m1.1) # the inflation in size of the confidence ellipse or ellipsoid for the coefficients of the term in comparison with what would be obtained for orthogonal data.
```


# Better understand what is causing error in datasets b and c


These show the error is caused by all individuals within a treatment having 0% or 100% methylation. Clearly, these are cases that are very interesting!

Googling "Warning message: In checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model failed to converge with max|grad| = 0.0129364 (tol = 0.001, component 1)"

This seems to be a very common error message, but I couldn't find a specific post that highlights the problem we discovered here.

## Let's try Bayesian MCMCglmm!

* Read Jared H's book in the Lotterhos Lab Reading / stats
* Good example [here](https://github.com/tmalsburg/MCMCglmm-intro)

```{r}

# These are default priors I found in some examples. I need to read up on these and

prior1=list(R=list(V=1, nu=0.002), G=list(G1=list(V=1, nu=0.002)))
prior2=list(R=list(V=1, nu=0.002), G=list(G1=list(V=1, nu=1,  
alpha.mu=0, alpha.V=100)))

# Real data
m2 <- MCMCglmm(cbind(mc,uc)~ Treatment*Time, random= ~tankID, 
               data=a,family = "multinomial2", prior=prior1)

plot(cbind(m2$VCV), pch=19, cex=0.2)
par(mfrow=c(4,2), mar=c(2,2,1,0))
plot(m2$Sol, auto.layout=F)
  # no autocorrelation in the traces, good!
summary(m2)
  # This result is interesting, more conservative P-values than
  # what we got with the glmer

# Fake data with 0's for methylation
m2 <- MCMCglmm(cbind(mc,uc)~ Treatment*Time, random= ~tankID, 
               data=c,family = "multinomial2", prior=prior1)

plot(cbind(m2$VCV), pch=19, cex=0.2)
par(mfrow=c(4,2), mar=c(2,2,1,0))
plot(m2$Sol, auto.layout=F)
  # some autocorrelation in the traces, not good!
summary(m2)

# Fake data with 0's for unmenthlated
b
m2 <- MCMCglmm(cbind(mc,uc)~ Treatment*Time, random= ~tankID, 
               data=c,family = "multinomial2", prior=prior1)

plot(cbind(m2$VCV), pch=19, cex=0.2)
par(mfrow=c(4,2), mar=c(2,2,1,0))
plot(m2$Sol, auto.layout=F)
  # lots of autocorrelation in the traces, not good! Will need to look into convergence issues
summary(m2)

# let's see if we can do better by changing the prior and increasing
# the number of iterations
m2 <- MCMCglmm(cbind(mc,uc)~ Treatment*Time, random= ~tankID, 
               data=c,family = "multinomial2", prior=prior2,
               thin   = 20,
               burnin = 3000,
               nitt   = 100000)
  # further increasing the thinning results in worse density plots;
  #
plot(cbind(m2$VCV), pch=19, cex=0.2)
par(mfrow=c(4,2), mar=c(2,2,1,0))
plot(m2$Sol, auto.layout=F)
summary(m2)
  # still some autocorrelation, but better than before
```

In this case we get an error message"In summary.glm(glm(cbind(MCMC_y, MCMC_y.additional) ~ 1, family = "quasibinomial",  :
  observations with zero weight not used for calculating dispersion"
  
There is one post on this:
https://stat.ethz.ch/pipermail/r-sig-mixed-models/2012q2/018129.html

Where the author of the package says this is not neccessarily anything to worry about.

## Let's try Bayesian brms!
[The github page has lots of great documentation](https://github.com/paul-buerkner/brms)

```{r}
vignette(package = "brms")
help("brm")

# No random effect of tank on real data
m3 <- brm(mc | trials(size)~ Treatment*Time, data=a,family = binomial())
  # takes a few seconds
summary(m3)
  # gives a similar result ot the GLM

# Add the random effect of tank
m3.1 <- brm(mc | trials(size)~ Treatment*Time + (1|tankID), data=a,family = binomial())
summary(m3.1)
plot(marginal_effects(m3.1), ask = FALSE)

# Try zero-inflated model
# https://paul-buerkner.github.io/brms/articles/brms_distreg.html
m3.2 <- brm(mc | trials(size)~ Treatment*Time + (1|tankID), data=a,family = zero_inflated_binomial())
summary(m3.2)
plot(marginal_effects(m3.2), ask = FALSE)
```

OK let's try the same thing, but with the data with 0's for unmethylated
```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=b, las=2)
# No random effect of tank on real data
m3 <- brm(mc | trials(size)~ Treatment*Time, data=b,family = binomial())
  # takes a few seconds
summary(m3)
  # gives a similar result ot the GLM
plot(marginal_effects(m3), ask = FALSE)

# Add the random effect of tank
m3.1 <- brm(mc | trials(size)~ Treatment*Time + (1|tankID), data=b,family = binomial(), iter=5000, control = list(max_treedepth = 15))
summary(m3.1)
plot(marginal_effects(m3.1), ask = FALSE)

quantile(posterior_samples(m3.1)$b_Treatment2800, c(0.0001, 0.9999))
quantile(posterior_samples(m3.1)$b_Time80, c(0.0001, 0.9999))
quantile(posterior_samples(m3.1)[,4], c(0.0001, 0.9999))
```

OK let's try the same thing, but with the data with 0's for methylated
Note this has some low count levels for the unmethylated section, need to fix that
```{r}
boxplot(mc/(mc+uc) ~ Treatment*Time, data=c, las=2)
# No random effect of tank on real data
m3 <- brm(mc | trials(size)~ Treatment*Time, data=c,family = binomial())
  # takes a few seconds
summary(m3)
pairs(m3)
  # gives a similar result ot the GLM
plot(marginal_effects(m3), ask = FALSE)
  # get warnings for this data

# Add the random effect of tank
m3.1 <- brm(mc | trials(size)~ Treatment*Time + (1|tankID), data=c,
            family = binomial(), iter=5000, control = list(max_treedepth = 15))
summary(m3.1)
plot(m3.1)

str(posterior_samples(m3.1))
quantile(posterior_samples(m3.1)$b_Treatment2800, c(0.0001, 0.9999))
quantile(posterior_samples(m3.1)$b_Time80, c(0.0001, 0.9999))
quantile(posterior_samples(m3.1)[,4], c(0.0001, 0.9999))

hypothesis(m3.1, "Time80 > 0", class="b", alpha=0.001)
  # Day 80 higher methylation than day 9
hypothesis(m3.1, "Time80 < 0", class="b", alpha=0.001)
  # Day 80 lower methylation than day 9
hypothesis(m3.1, "Treatment2800 > 0", class="b", alpha=0.001)
  # 2800 higher methylation than day 400
hypothesis(m3.1, "Treatment2800 < 0", class="b", alpha=0.001)
  # 2800 lower methylation than day 400
hypothesis(m3.1, "Treatment2800:Time80 > 0", class="b", alpha=0.001)
  # The change in 2800 from day 9 to 80 is greater than the change 
  # in the 400 treatment from day 9 to 80
hypothesis(m3.1, "Treatment2800:Time80 < 0", class="b", alpha=0.001)
  # The change in 2800 from day 9 to 80 is LESS than the change 
  # in the 400 treatment from day 9 to 80

plot(marginal_effects(m3.1), ask = FALSE)
  # get warnings for this data for iter = 2000 and default treedepth
  # get no warnings when increasing iter and treedepth
  # https://mc-stan.org/misc/warnings.html#maximum-treedepth-exceeded

pairs(m3.1)
  # in this plot want to look for iterations off the 1:1 line
  # colored in red or yellow 
  # https://mc-stan.org/misc/warnings.html

```

```{r}
m4.1 <- brm(mc | trials(size)~ level + (1|tankID), data=c,
            family = binomial(), iter=5000, control = list(max_treedepth = 15))
summary(m4.1)
plot(m4.1)
str(posterior_samples(m4.1))
plot(marginal_effects(m4.1), ask = FALSE)


hypothesis(m4.1, "level2800_80=0", class="b", alpha=0.001)
  # Is 2800_80 different from 2800_09

hypothesis(m4.1, "level2800_80=level400_09", class="b", alpha=0.001)

hypothesis(m4.1, "level2800_80=level400_80", class="b", alpha=0.001)

hypothesis(m4.1, "level400_09=level400_80", class="b", alpha=0.001)

hypothesis(m4.1, "level400_09=0", class="b", alpha=0.001)
  # Is day 9 at 400 the same as day 80 at 400
```

Note that I do not think we have a zero-inflated model. This model assumes that the sample is a “mixture” of two sorts of individuals: one group whose counts are generated by the standard binomial regression model, and another group (call them the absolute zero group) who have zero probability of a count greater than 0. 

In our case, we may have 0% or 100% methylation, but the counts are greater than 0 in at least one of the categories.

# Try Beta-binomial to account for overdispersion
(This gave all kinds of errors... will revisit later)

https://paul-buerkner.github.io/brms/articles/brms_customfamilies.html

beta_binomial2 <- custom_family(
  "beta_binomial2", dpars = c("mu", "phi"),
  links = c("logit", "log"), lb = c(NA, 0),
  type = "int", vars = "trials[n]"
)

stan_funs <- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {
    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);
  }
  int beta_binomial2_rng(real mu, real phi, int T) {
    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);
  }
"

stanvars <- stanvar(scode = stan_funs, block = "functions") +
  stanvar(as.integer(a$size), name = "trials")

m3.2 <- brm(mc | trials(size)~ Treatment*Time + (1|tankID), data=a,family = beta_binomial2, stanvars = stanvars)

summary(m3.2)
