---
title: "CV17_RNA_geneExpression"
author: "adowneywall"
date: "December 17, 2018"
output: html_document
---

```{r setup}
library(fdrtool)
library(edgeR)
library(limma)



```

#### Using limma tools along with DGEList objects to perform association tests
```{r}
## Voom 
v <- voom(dgeNorm,design)
## Fit a linear model using normalized data and design matrix
fit <- lmFit(v,design)
fit2 <- lmFit(v2,design)
#Correct with eBayes
fit <- eBayes(fit)
fit2 <- eBayes(fit2)
# 
# dim(fit2$p.value)
# fit2$lods
# 
# 
# fdr_out <- fdrtool(fit2$F.p.value,statistic = c("normal"),verbose = F,plot = T)
# 
# gif <- median(fit2$F.p.value^2)/0.456
# pcal <- pchisq(fit2$F.p.value^2/gif , df = 1, low = F)
# plot(density(pcal))
# 
# volcanoplot(fit,coef=2,highlight=2)
# volcanoplot(fit2,coef=2,highlight=2)
```

### Cate Test

#### Single Time / Treatment variable
```{r}
library(cate)
library(fdrtool)
thres <-  0.05
# Convert y log expression data into matrix
#Y <- matrix(unlist(yLog),ncol=ncol(yLog))
Y <- matrix(unlist(y),ncol=ncol(y))
colnames(Y) <- colnames(yLog)
row.names(Y) <- row.names(yLog)

#### Running example is with include time and treatment together
## sum treatment and time into single variable
sumLevels <- design[,1] + design[,2]*2 + design[,3]*3 + design[,4]*4
#create new dataframe with trt/time as predictor and pop and shelf as covariates
design_config <- data.frame(X = sumLevels,pop=model$population,block=model$shelf)
# Estimate number of latent factors
#factor.num <- est.confounder.num(~ X | . - X + 0,
#                                 design_config, t(Y),
#                                 method = "bcv", bcv.plot = FALSE,
#                                 rmax = 30, nRepeat = 20)
#factor.num$r #huh, only 1

# Manually changed it to 2 based on earlier PCA
cate.results <- cate(~ X | . - X + 0,
                     design_config, 
                     t(Y), 
                     r = 2,
                     adj.method = "rr")
## GLM including latent factors from cate in the model
p <- NULL
z <- NULL
for (l in 1:nrow(Y)){
  scores<-glm(t(Y)[,l] ~ design_config$X + design_config$pop + design_config$block + cate.results$Z)
  p[l] <- summary(scores)$coeff[2,4]
  z[l] <- summary(scores)$coeff[2,3] 
}
#Genomic Inflation Factor
gif <- median(z^2)/0.456
gif
## FDR tools used to correct for multiple hyps.
fdr.adj<-fdrtool(z,statistic = c("normal"))
qvals <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals) <- row.names(yLog)
plot(c(1-qvals[,1])~c(1:nrow(Y)))
abline(h = 0.95,col="red")

plot(c(1-qvals[,1])~c(1:nrow(Y)))
abline(h = 0.95,col="red")
diff_genes <- cbind(Test="Trt_Time",Gene_ID = names(qvals[,1])[which(qvals[,1]<thres)],Qval = qvals[,1][which(qvals[,1]<thres)],lfdr = qvals[,2][which(qvals[,1]<thres)])
```  

#### Single Time / Treatment variable (using normalized data from voom)
```{r}
library(cate)
library(fdrtool)
thres <-  0.05

#### Running example is with include time and treatment together
## sum treatment and time into single variable
sumLevels <- design[,1] + design[,2]*2 + design[,3]*3 + design[,4]*4
#create new dataframe with trt/time as predictor and pop and shelf as covariates
design_config <- data.frame(X = sumLevels,pop=model$population,block=model$shelf)
# Estimate number of latent factors
factor.num <- est.confounder.num(~ X | . - X + 0,
                                 design_config, t(v2$E),
                                 method = "bcv", bcv.plot = FALSE,
                                 rmax = 30, nRepeat = 20)
factor.num$r #huh, only 1

# Manually changed it to 2 based on earlier PCA
cate.results <- cate(~ X | . - X + 0,
                     design_config, 
                     t(v2$E), 
                     r = 2,
                     adj.method = "rr")
## GLM including latent factors from cate in the model
p <- NULL
z <- NULL
for (l in 1:nrow(v2$E)){
  scores<-glm(t(v2$E)[,l] ~ design_config$X + design_config$pop + design_config$block + cate.results$Z)
  p[l] <- summary(scores)$coeff[2,4]
  z[l] <- summary(scores)$coeff[2,3] 
}
#Genomic Inflation Factor
gif <- median(z^2)/0.456
gif
## FDR tools used to correct for multiple hyps.
fdr.adj<-fdrtool(z,statistic = c("normal"))
qvals <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals) <- row.names(yLog)
plot(c(1-qvals[,1])~c(1:nrow(v2$E)))
abline(h = 0.95,col="red")

diff_voom_genes <- cbind(Test="Trt_Time_Voom",Gene_ID = names(qvals[,1])[which(qvals[,1]<thres)],Qval = qvals[,1][which(qvals[,1]<thres)],lfdr = qvals[,2][which(qvals[,1]<thres)])
```

#### Differences by treatment
```{r}
#### Running example is with include time and treatment together
## sum treatment and time into single variable
trt <- design[,1] + design[,2] # 1 for all samples with 2800 trt and 0 for 400
time <-  design[,2] + design[,4]# 1 for time 6 adn 0 for tp 3
design_config <- data.frame(trt=trt,time=time,pop=model$population,block=model$shelf)

# Estimate number of latent factors
factor.num <- est.confounder.num(~ trt | . - trt + 0,
                                 design_config, t(Y),
                                 method = "bcv", bcv.plot = FALSE,
                                 rmax = 30, nRepeat = 20)
#Numbers of factors
factor.num$r 

# Manually changed it to 2 based on earlier PCA
cate.results <- cate(~ trt | . - trt + 0,
                     design_config, 
                     t(Y), 
                     r = 2,
                     adj.method = "rr")

## GLM including latent factors from cate in the model
p <- NULL
z <- NULL
for (l in 1:nrow(Y)){
  scores<-glm(t(Y)[,l] ~ design_config$trt + design_config$pop + design_config$block + cate.results$Z)
  p[l] <- summary(scores)$coeff[2,4]
  z[l] <- summary(scores)$coeff[2,3] 
}

#Genomic Inflation Factor
(gif <- median(z^2)/0.456)
gif

## FDR tools used to correct for multiple hyps.
fdr.adj<-fdrtool(z,statistic = c("normal"))

qvals <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals) <- row.names(yLog)
plot(c(1-qvals[,1])~c(1:nrow(Y)))
abline(h = 0.95,col="red")
if(length(which(qvals[,1]<thres)) > 0){
  diff_trt_genes <- cbind(Test="Trt",Gene_ID = names(qvals[,1])[which(qvals[,1]<thres)],Qval = qvals[,1][which(qvals[,1]<thres)],lfdr = qvals[,2][which(qvals[,1]<thres)])
}

```

#### Differences by time
```{r}
# Estimate number of latent factors
# factor.num <- est.confounder.num(~ time | . - time + 0,
#                                  design_config, t(Y),
#                                  method = "bcv", bcv.plot = FALSE,
#                                  rmax = 30, nRepeat = 20)
# # Number of factors
# factor.num$r

# Manually changed it to 2 based on earlier PCA
cate.results <- cate(~ time | . - time + 0,
                     design_config, 
                     t(yLog), 
                     r = 2,
                     adj.method = "rr")

## GLM including latent factors from cate in the model
p <- NULL
z <- NULL
for (l in 1:nrow(yLog)){
  scores<-glm(t(yLog)[,l] ~ design_config$time + design_config$pop + design_config$block + cate.results$Z)
  p[l] <- summary(scores)$coeff[2,4]
  z[l] <- summary(scores)$coeff[2,3] 
}

#Genomic Inflation Factor
gif <- median(z^2)/0.456
gif

## FDR tools used to correct for multiple hyps.
fdr.adj<-fdrtool(z,statistic = c("normal"))

qvals <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals) <- row.names(yLog)
plot(c(1-qvals[,1])~c(1:nrow(yLog)))
abline(h = 0.95,col="red")

diff_time_genes <- cbind(Test="Time",Gene_ID = names(qvals[,1])[which(qvals[,1]<thres)],Qval = qvals[,1][which(qvals[,1]<thres)],lfdr = qvals[,2][which(qvals[,1]<thres)])
```

```{r}
significant_genes <- data.frame(rbind(diff_genes,diff_voom_genes,diff_time_genes,diff_trt_genes))
significant_genes$Qval <- as.numeric(as.character(significant_genes$Qval))  
significant_genes$lfdr <- as.numeric(as.character(significant_genes$lfdr))  

library(dplyr)

ggplot(significant_genes,aes(x=Gene_ID,y=log(as.numeric(as.character(Qval))),color=Test)) + geom_point()

sg_order <- significant_genes[order()]
```

#### Full model - voom scaled counts  

$$ {Gene_{i} \sim Treatment + Time + Treatment:Time + Population + Block + LF $$  

```{r}
library(cate)
library(fdrtool)
thres <-  0.08

#### Running example is with include time and treatment together
## sum treatment and time into single variable
trt <- design[,1] + design[,2] # 1 for all samples with 2800 trt and 0 for 400
time <-  design[,2] + design[,4]# 1 for time 6 adn 0 for tp 3
design_config <- data.frame(trt=trt,time=time,pop=model$population,block=model$shelf)
# Estimate number of latent factors
# factor.num <- est.confounder.num(~ time | . - time + 0,
#                                  design_config, t(v2$E),
#                                  method = "bcv", bcv.plot = FALSE,
#                                  rmax = 30, nRepeat = 20)
# factor.num$r #huh, only 1

# Manually changed it to 2 based on earlier PCA
cate.results <- cate(~ trt*time | . - trt*time + 0,
                     design_config, 
                     t(v2$E), 
                     r = 2,
                     adj.method = "rr")
## GLM including latent factors from cate in the model
p_time <- NULL
z_time <- NULL
p_trt <- NULL
z_trt <- NULL
p_inter <- NULL
z_inter <- NULL
for (l in 1:nrow(v2$E)){
  scores<-glm(t(v2$E)[,l] ~ design_config$time*design_config$trt + design_config$pop + design_config$block + cate.results$Z)
  p_time[l] <- summary(scores)$coeff[2,4]
  z_time[l] <- summary(scores)$coeff[2,3] 
  p_trt[l] <- summary(scores)$coeff[3,4]
  z_trt[l] <- summary(scores)$coeff[3,3] 
  p_inter[l] <- summary(scores)$coeff[8,4]
  z_inter[l] <- summary(scores)$coeff[8,3] 
}
#Genomic Inflation Factor
gif <- median(z_inter^2)/0.456
gif
## FDR tools used to correct for multiple hyps.

# for time
fdr.adj<-fdrtool(z_time,statistic = c("normal"))
qvals_time <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals_time) <- row.names(yLog)
plot(c(1-qvals_time[,1])~c(1:nrow(yLog)))
abline(h = 0.95,col="red")

time_diff_genes <- cbind(Predictor="Time",Gene_ID = names(qvals_time[,1])[which(qvals_time[,1]<thres)],Qval = qvals_time[,1][which(qvals_time[,1]<thres)],lfdr = qvals_time[,2][which(qvals_time[,1]<thres)])

# for trt
fdr.adj<-fdrtool(z_trt,statistic = c("normal"))
qvals_trt <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals_trt) <- row.names(yLog)
plot(c(1-qvals_trt[,1])~c(1:nrow(yLog)))
abline(h = 0.95,col="red")

trt_diff_genes <- cbind(Predictor="Treatment",Gene_ID = names(qvals_trt[,1])[which(qvals_trt[,1]<thres)],Qval = qvals_trt[,1][which(qvals_trt[,1]<thres)],lfdr = qvals_trt[,2][which(qvals_trt[,1]<thres)])

# for inter
fdr.adj<-fdrtool(z_inter,statistic = c("normal"))
qvals_inter <- matrix(cbind(fdr.adj$qval,fdr.adj$lfdr),ncol=2)
row.names(qvals_inter) <- row.names(v2$E)
plot(c(1-qvals_inter[,1])~c(1:nrow(yLog)))
abline(h = 0.95,col="red")

inter_diff_genes <- cbind(Predictor="Time:Treatment Interaction",Gene_ID = names(qvals_inter[,1])[which(qvals_inter[,1]<thres)],Qval = qvals_inter[,1][which(qvals_inter[,1]<thres)],lfdr = qvals_inter[,2][which(qvals_inter[,1]<thres)])
```


```{r}
significant_genes <- data.frame(rbind(trt_diff_genes,time_diff_genes,inter_diff_genes))
significant_genes$Qval <- as.numeric(as.character(significant_genes$Qval))  
significant_genes$lfdr <- as.numeric(as.character(significant_genes$lfdr))  

library(dplyr)

ggplot(significant_genes,aes(x=Gene_ID,y=log(as.numeric(as.character(Qval))),color=Test)) + geom_point()

sg_order <- significant_genes[order()]

table(significant_genes$Gene_ID)

sig_summary <-  significant_genes %>% group_by(Predictor) %>%summarize(n=n())
sig_summary$n
ggplot(sig_summary,aes(x=Predictor,y=n,fill=Predictor)) + geom_bar(stat="identity") + labs(y="Number of significant genes")
ggsave("~/Github/2017OAExp_Oysters/figures/numberOfSignificantGenesByPredictor.png",width=15,height=10,units="cm")
```



#### Venn diagram of genes associated with predictor variables
```{r}
# library(VennDiagram)
# grid.newpage()
# draw.triple.venn(area1 = length(trt_loci), area2 = length(time_loci), area3 = length(trtTimeCombine_loci),
#                  n12 = length(trt_loci[!is.na(match(trt_loci,time_loci))]),
#                  n23 = length(trt_loci[!is.na(match(time_loci,trtTimeCombine_loci))]), 
#                  n13 = length(trt_loci[!is.na(match(trt_loci,trtTimeCombine_loci))]),
#                  n123 = length(trt_loci[!is.na(match(trt_loci,time_loci))]),
#                  category = c("Treatment", "Time", "Treatment and Time Combined"), lty = "blank", 
#                  fill = c("skyblue", "pink1", "mediumorchid"))
```

#### Venn diagram cate + glm vs voom comparison (with Treatment + Time combination variable)
```{r}
# method_overlap <- length(trt_loci[!is.na(match(trtTimeCombine_loci,trtTimeCombine_voom_loci))])
# just_cate <- length(trtTimeCombine_loci) - method_overlap 
# just_voom <- length(trtTimeCombine_voom_loci) - method_overlap 
# 
# 
# if(just_cate == 0 | just_voom == 0){
#   print("No Venn diagram possible...")
#   if(just_cate == 0 & just_voom == 0){
#     print(paste("All ",method_overlap," genes were found to overlap between methods",sep=""))
#   }else{
#     if(just_cate == 0){
#       print(paste(length(trtTimeCombine_voom_loci), " genes were siginificant with voom normalization methods. Of these, ", method_overlap," genes found with voom normalization were found to overlap between methods",sep=""))
#     }else{
#       print(paste(length(trtTimeCombine_loci), " genes were siginificant with cate (latent factor) methods. Of these, ", method_overlap," genes found with voom normalization were found to overlap between methods",sep=""))
#     }
#   }
# }else{
#   # draw.triple.venn(just_cate,just_voom,
#   #                length(trt_loci[!is.na(match(trtTimeCombine_loci,trtTimeCombine_voom_loci))]),
#   #                category = c("Treatment and Time Combined", "Treatment and Time Combined (voom)"), lty = "blank", 
#   #                fill = c("skyblue", "mediumorchid"))
# }
```