---
title: "CV17 Extra Pallial Fluid Analysis"
author: "adowneywall"
date: "April 10, 2019"
output: 
  html_document:
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(car)
library(lme4)
library(lmerTest)
library(kableExtra)
library(multcompView)
```

## Data Input and Formatting
```{r}
### EPF fluid ###
epf_cal <- read.csv(file = "~/Github/2017OAExp_Oysters/input_files/Phenotype/EPF/AE17_EPF_Calcification_20190403.csv")
# Remove and NAs at end of dataframe
epf_cal <- epf_cal[!is.na(epf_cal$ID),]
# Making Date object
epf_cal$Sample_Date <- as.Date(as.character(epf_cal$sample_date),origin="%Y%m%d",format="%Y%m%d")
# Removing samples outside of experiment (those for louises exp)
epf_cal <- epf_cal[epf_cal$Sample_Date < "2017-08-25",]
epf_cal <- epf_cal[!is.na(epf_cal$Sample_Date),]
#aggreate final two timepoints
epf_cal$Sample_Date[epf_cal$Sample_Date > "2017-08-20"] <-"2017-08-23"
  
# Convert Dates into timepoints (time prior to experiment exposure starting)
epf_cal$timepoint <-  epf_cal$Sample_Date - as.Date("2017-06-04")
epf_cal$timepoint_fac <-  as.factor(epf_cal$timepoint)

## Deciding to treat time and treatment as factors
# Aggregating data pre exposure leveles to 400
epf_cal$pCO2[epf_cal$timepoint < 0] <- 400
#Covnert to factor
epf_cal$pCO2_fac <-  as.factor(epf_cal$pCO2)

### Water Chemistry ###
wc <-  read.csv(file="~/Github/2017OAExp_Oysters/input_files/WC/AE17_pHSalinity_20180305.csv")

# Meta data with sample sequence info
ss <- read.csv(file="/home/downeyam/Github/2017OAExp_Oysters/input_files/RNA/metadata_cvirginica_rna_meta.txt")
ss$ID <- as.numeric(substr(ss$sample_name,4,10))
# Data set with population information
sp <- read.csv("/home/downeyam/Github/2017OAExp_Oysters/input_files/Phenotype/AE17_Exp_2017_CollectionInfo_20190227.csv")
sp_pop <- subset(sp,select=c(ID,pop))

# Merge population data with phenotype data
epf_cal <- merge(epf_cal,sp_pop,by="ID")

#Subset data to include just those that were sequenced
just_seq <- epf_cal[!is.na(match(epf_cal$ID,ss$ID)),]
```

### **Sample Tables**

All Samples
```{r}
kable(table(epf_cal$pCO2_fac,epf_cal$timepoint_fac)) %>%
  kable_styling()
```
  
Sample with complete carbonate chemistry
```{r}
kable(table(epf_cal[!is.na(epf_cal$EPF_DIC_Start),]$pCO2_fac,epf_cal[!is.na(epf_cal$EPF_DIC_Start),]$timepoint_fac)) %>%
  kable_styling()
```
  
Samples we also sequenced
```{r}
kable(table(just_seq$pCO2_fac,just_seq$timepoint_fac)) %>%
  kable_styling()
```
  
Samples we also sequenced with complete carbonate chemistry
```{r}
kable(table(just_seq[!is.na(just_seq$EPF_DIC_Start),]$pCO2_fac,just_seq[!is.na(just_seq$EPF_DIC_Start),]$timepoint_fac)) %>%
  kable_styling()
```

## Plans

* Look at EPF pH for all timepoints and treatments (6 tp, 3 treatments, 108 individuals, mostly balanced)  
* Look at EPF pH for all individuals we sequenced (2 tp, 2 treatments, 24 individuals)  
* Look at EPF complete chemistry for samples we sequenced and have complete chemistry (2 tp, 2 treatments, 10 individuals, not balanced)  

## Analysis of EPF pH total data  
  
* Filtering out NAs (one entry) and including only timepoints from the exposure (not acclimation)
```{r echo=FALSE}
epf_exp <- epf_cal[!is.na(epf_cal$EPF_pH),]
epf_exp <- epf_exp[as.numeric(epf_exp$timepoint) > 0,]
#epf_exp <- epf_exp[!epf_exp$pCO2_fac == 900,]

# Exploratory plot
n_sample <- epf_exp %>% group_by(pCO2_fac,timepoint_fac) %>% summarise(n=length(pCO2_fac),y.pos=quantile(pH_meas)[4])

give.n <- function(x){
   return(c(y = 7.8, label = length(x)))
}
trt_color <- c("deepskyblue3", "darkorange", "firebrick")
ggplot(epf_exp,aes(y=EPF_pH,x=timepoint_fac,group=interaction(timepoint_fac,pCO2_fac),colour=pCO2_fac)) + 
  geom_boxplot() +
  scale_color_manual(values=trt_color) + 
  theme_bw() +
  stat_summary(fun.data = give.n,
               geom = "text",
               position = position_dodge(width = 0.9), vjust = -0.25) + 
  labs(title="EPF pH",x="Time",y="EPF pH",colour="pCO2")
```
  
### **Statistcal Analysis**  
  
#### **EPF pH total data - time as factor**  
**Overview**  
Test: 2-way ANOVA - Full Model (Fixed and Random Factors)  
* Explanatory Factors: Treatment (pCO2_fac) and Time (timepoint_fac)  
* Random Factors: Population, Shelf, Tank (nested in Shelf)   
* Tested for normality and variance assumptions  
  
```{r}
whole_factor_full <- lmer(EPF_pH~timepoint_fac*pCO2_fac + (1|pop) + (1|shelf/tank),data=epf_exp) #
# Warning singular fit

# Check distribution of residuals
plot(whole_factor_full)
# They look fairly homoscedastic
qqnorm(resid(whole_factor_full))
qqline(resid(whole_factor_full))

anova(whole_factor_full)
# Nothing significant here (although the interaction is close)

ranova(whole_factor_full)
# We should remove population and shelf as random factors and rerun analysis

```
  
**Rerun Model with Population and Shelf removed as random factors**
```{r}
whole_factor_tank <- lmer(EPF_pH~timepoint_fac*pCO2_fac + (1|tank:shelf),data=epf_exp)
# Prevented singular fit issue this time

# Check distribution of residuals
plot(whole_factor_tank)
# They look fairly homoscedastic
qqnorm(resid(whole_factor_tank))
qqline(resid(whole_factor_tank))
# Fairly normal

anova(whole_factor_tank)

anova(whole_factor_full,whole_factor_tank)
# Comparing the two models  (full and w/ tank only there is no difference)
# We keep the simpler model
```
  
#### **EPF pH total data - treatment as factor and time as continuous variable**  
**Overview**  
Test: 2-way ANCOVA 
* Explainatory Factors: Treatment (pCO2_fac)   
* Continuous covariate: Time (timepoint)  
* Random Facotrs: Population, Shelf, Tank  
* Tested for normality and variance assumptions  
  
```{r}
whole_cont_full <- lmer(EPF_pH~timepoint*pCO2_fac + (1|pop) + (1|shelf/tank) ,data=epf_exp)
# ERROR -  looks like this is driven by too many explanatory parameters

ranova(whole_cont_full)
# Looks like we can remove the random effects anyways
# Ill start by removing population and shelf and reruning
```

**Rerun model with just tank as random factor**
```{r}
whole_cont_tank <- lmer(EPF_pH~timepoint*pCO2_fac + (1|tank:shelf) ,data=epf_exp)

# Check distribution of residuals
plot(whole_cont_tank)
# They look fairly homoscedastic
qqnorm(resid(whole_cont_tank))
qqline(resid(whole_cont_tank))
# Fairly normal

ranova(whole_cont_tank)
# Not significant but good to keep i think

anova(whole_cont_tank)
summary(whole_cont_tank)
# Nothing significant :(
```

**Automated Model Selection**
```{r}
step(whole_cont_full)
# Model Select only pCO2fac and tank

whole_pCO2_tank <- lmer(EPF_pH~pCO2_fac + (1|tank:shelf) ,data=epf_exp)

# Check distribution of residuals
plot(whole_pCO2_tank)
# They look fairly homoscedastic
qqnorm(resid(whole_pCO2_tank))
qqline(resid(whole_pCO2_tank))
# Fairly normal

anova(whole_pCO2_tank)
#Significant!
```
  
## Analysis of samples we sequenced  

#### **EPF pH total data - time as factor**  
**Overview**  
Test: 2-way ANOVA - Full Model (Fixed and Random Factors)  
* Explanatory Factors: Treatment (pCO2_fac) and Time (timepoint_fac)  
* Random Factors: Population, Shelf, Tank (nested in Shelf)   
* Tested for normality and variance assumptions  

```{r}
seq_full <- lmer(EPF_pH~timepoint_fac*pCO2_fac + (1|pop) + (1|shelf/tank),data=just_seq)
# Singular fit warning

anova(seq_full) # Everything is signficant

plot(seq_full)
# Some heteroscedascity but not too bad
qqnorm(resid(seq_full))
qqline(resid(seq_full))

ranova(seq_full) # None of these seem important

anova(seq_full) # Everything except pCO2 significant

# Decide to remove random factors since they aren't informative
```

**Rerun with standard lm**
```{r}
seq_fixed <- lm(EPF_pH~timepoint_fac*pCO2_fac, data=just_seq)

plot(seq_fixed)
# We can see more clearly that some of the mild issues with the assumptions are being driven by 3 points (4,60,61).

anova(seq_fixed) # without random factors, pCO2 is now even less significant
```
  
**Rerun but remove those three problematic points**
```{r}
# New dataset w/o those three points
just_seq2 <- just_seq[!row.names(just_seq) == c(4,60,61),]

seq_fixed_outlierRM <- lm(EPF_pH~timepoint_fac*pCO2_fac, data=just_seq2)

plot(seq_fixed_outlierRM)
# On a whole this looks like a slight improvement

anova(seq_fixed_outlierRM) # Now everything is significant
```
  
**Pairwise comparisons of fixed factor model (with points rm)**  
```{r}
seq_pairwise <- TukeyHSD(aov(EPF_pH~timepoint_fac*pCO2_fac, data=just_seq2))

plot(seq_pairwise$`timepoint_fac:pCO2_fac`)
```
  
**Final Figure**  
```{r echo=FALSE}

seq2_means <- aggregate(EPF_pH~timepoint_fac+pCO2_fac,just_seq2,FUN=mean)
SE <- function(x){
  sd(x)/(sqrt(length(x)))
}
seq2_SE <- aggregate(EPF_pH~timepoint_fac+pCO2_fac,just_seq2,FUN=SE)

seq_labels <- multcompLetters(seq_pairwise$`timepoint_fac:pCO2_fac`[, "p adj"])$Letters
seq_labels <- seq_labels[c(1,2,4,3)]


bp <- barplot(seq2_means$EPF_pH,ylim=c(6.5,8.1),col=c("blue","red","blue","red"),ylab = "EPF pH",
              xpd = FALSE)
arrows(x0 = bp, x1 = bp, y0 = seq2_means$EPF_pH - seq2_SE$EPF_pH, y1 = seq2_means$EPF_pH +
seq2_SE$EPF_pH, angle = 90, len = 0.1, code = 3, xpd = NA)
text(x = bp, y = 6.4, label = c("Control","OA","Control","OA"), xpd = NA)
text(x = mean(bp[1:2]), y = 6.3, label = "Day 9", xpd = NA)
text(x = mean(bp[3:4]), y = 6.3, label = "Day 80", xpd = NA)
box()
text(x = bp, y = seq2_means$EPF_pH + seq2_SE$EPF_pH, pos = 3, lab = seq_labels, xpd = NA)
```
  
Final bar plot has SE bars and significance levels based on pairwise comparison test (tukey method) based on model selected above.
  
**Automated Model Selection**
```{r}
step(seq_full)
# Automated processed converged on the same model as above
```
  
### Analysis of samples data with **Complete Carbonate Chemistry** (WARNING VERY LOW SAMPLE SIZE)  

* This is data that we measured both the EPF pH and DIC of extract EPF Fluid in order to calculate the complete carbonate chemistry  

**Days : Day 0 (pre exposure), Day 9, Day 80**  
```{r}
# Select specific columns and only keep rows with complete carbonate chemistry
col_select <- c("ID","shelf","tank","pCO2_fac","DIC","TA","pCO2_calc","Calcite","pH_meas","sample_date","timepoint","timepoint_fac","EPF_pH","EPF_DIC_Start","EPF_Ca_Start")
epf_cal %>% select(col_select) %>% filter(!is.na(EPF_Ca_Start)) -> epf_s
epf_s$timepoint_fac <-  factor(epf_s$timepoint_fac)
levels(epf_s$timepoint_fac)  <-  c("Pre-Exposure","Day 9","Day 80")

# Aggregating WC for experiment
epf_s %>% filter(timepoint > 0) %>% group_by(pCO2_fac) %>%
  summarize(DIC=mean(DIC),TA=mean(TA),pH = mean(pH_meas),act_pCO2 = mean(pCO2_calc),Calcite = mean(Calcite)) -> sum_WC
  
# Exploratory Plots

#Color Scheme
# Default orderL 400,900,2800
trt_color <- c("deepskyblue3", "darkorange", "firebrick")
#pH
give.n <- function(x){
   return(c(y = 7.9, label = length(x)))
}
ggplot(epf_s,aes(x=timepoint_fac,y=EPF_pH,group=interaction(pCO2_fac,timepoint_fac),colour=pCO2_fac)) + 
  geom_hline(yintercept= sum_WC$pH,col=trt_color,size=1) + 
  geom_boxplot() + 
  scale_color_manual(values=trt_color) + 
  theme_bw() +
  stat_summary(fun.data = give.n,
               geom = "text",
               position = position_dodge(width = 0.9), vjust = -0.25) +
  labs(title="EPF pH",x="Time",y="EPF pH",colour="pCO2")
# Calcite
ggplot(epf_s,aes(x=timepoint_fac,y=EPF_Ca_Start,group=interaction(pCO2_fac,timepoint_fac),colour=pCO2_fac)) + 
  geom_hline(yintercept= sum_WC$Calcite,col=trt_color,size=1) + 
  geom_boxplot() + 
  scale_color_manual(values=trt_color) + 
  theme_bw() +
  labs(title="EPF Calcite",x="Time",y="EPF Ca",colour="pCO2")
# DIC
ggplot(epf_s,aes(x=timepoint_fac,y=EPF_DIC_Start,group=interaction(pCO2_fac,timepoint_fac),colour=pCO2_fac)) + 
  geom_hline(yintercept= sum_WC$DIC,col=trt_color,size=1) + 
  geom_boxplot() + 
  scale_color_manual(values=trt_color) + 
  theme_bw() +
  labs(title="EPF DIC",x="Time",y="EPF DIC",colour="pCO2")
```
**Figure Notes**: Horizontal lines represent the mean environment value for each the the treatment levels.
  
**Subsetting data for stats**
```{r}
# Lets only look at exposure timepoints here
epf_s_Exp <- epf_s[epf_s$timepoint > 2,]
# Only two treatment levels we have molecular data for (~400,~2800)
epf_s_Exp <- epf_s_Exp[!epf_s_Exp$pCO2_fac==900,]
```
  
#### **Statistical Analysis**

**Overview**  
Test: 2-way ANOVA - 
* Explainatory Factors: Treatment (pCO2_fac) and Time (timepoint_fac)
* Tested for normality and variance assumptions - log transformed EPF data if needed
  
**NOTE** : Due to extremely lower power hear I don't think we really even have the option of using random effects  

**EPF Calcite**
```{r}
mod_1 <- lm(EPF_Ca_Start~pCO2_fac*timepoint_fac,data=epf_s_Exp)

qqnorm(mod_1$residuals)
qqline(mod_1$residuals)

# resids a little wonky trying a transformation
mod_2 <-  lm(log(EPF_Ca_Start)~pCO2_fac*timepoint_fac,data=epf_s_Exp)
qqnorm(mod_2$residuals)
qqline(mod_2$residuals)
#Slight improvement

leveneTest(log(epf_s_Exp$EPF_Ca_Start)~epf_s_Exp$pCO2_fac*epf_s_Exp$timepoint_fac)
# Seem to be OK

## Running ANOVA
(aov_2 <-aov(mod_2))
summary(aov_2)
# :( close but not significant (might be limited power here)
```

**DIC**
```{r}
mod_1 <- lm(EPF_DIC_Start~pCO2_fac*timepoint_fac,data=epf_s_Exp)

qqnorm(mod_1$residuals)
qqline(mod_1$residuals)

leveneTest(log(epf_s_Exp$EPF_DIC_Start)~epf_s_Exp$pCO2_fac*epf_s_Exp$timepoint_fac)
# Seem to be OK

## Running ANOVA
(aov_1 <-aov(mod_1))
summary(aov_1)
# :( close but not significant (might be limited power here)
```

**pH**
```{r}
mod_1 <- lm(EPF_pH~pCO2_fac*timepoint_fac,data=epf_s_Exp)

qqnorm(mod_1$residuals)
qqline(mod_1$residuals)

leveneTest(log(epf_s_Exp$EPF_pH)~epf_s_Exp$pCO2_fac*epf_s_Exp$timepoint_fac)
# Seem to be OK

## Running ANOVA
(aov_1 <-aov(mod_1))
summary(aov_1)
# :( close but not significant (might be limited power here)
```

