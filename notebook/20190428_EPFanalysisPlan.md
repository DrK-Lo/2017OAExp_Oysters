# Outline plane for EPF analysis

### DATA STRUCTURE

**Response Variable(s)**

- Extrapallial fluid Chemistry
  - ph : All timepoints (Pre, 24hr, 36hr, 9day, 22day, 50day, 80day) : 3 treatments
  - DIC : Three timepoints (Pre Exp, Day 9 , Day 80) : 2 treatments (ambient and elevate)
  - Ca Saturation State :  Three timepoints (Pre Exp, Day 9 , Day 80) : 2 treatments (ambient and elevate)

- Calcification Rate

**Explanatory Variables**

- Fixed
-   OA Treatment : 2 levels : ~500-2850 ppm 
-   Time : 2 levels :  Day 9 or Day 80

- Random
  - Population : 3 levels: Ipwich, Rowley1, and Rowley2
  - Shelf : 6 levels : 6 shelfs (each with three tanks
  - Tank : 3 levels : 3 tanks per shelf (NESTED within shelf)
    - NOTE: for resolution we only have complete WC at the shelf level.
  - Sample :  24 levels :  1 for each sample
    
### SAMPLE DISTRIBUTION  

### MODEL OPTIONS  

**NOTE**: models described using ```lmer``` notation.

#### **Examining EPF pH across the entire experiment**

FULL_MODEL : EPF ~ Treatment + Time + Treatment:Time + (1|Population) + (1|Shelf/Tank)
  - Note: Tank is nested in shelf
  
Simple_MODEL : EPF ~ Treatment + Time + Treatment:Time

### Model Creating, Testing and Evaluationm

**Packages Needed**
- ```lme4``` :  Needed to perform linear mixed effects models with random effects using ```lmer()``` function.
- ```lmerTest``` : Good for generating significance values for random effects models generated by ```lmer()```. Also has functions for model testing. (NOTE: this overloads ```lmer``` function to create new object that can be used to test for significant effect of fixed and random factors).
  - Additional function in package
    - ```anova``` : updates this function so its compatible with lmer models using Satterthwaite and Kenward-Roger methods for denominator degrees of freedom for F-tests.
    - ```ranova``` : Test the significance of all random effects
    - ```step``` : works backwords to determine the the 'best' model
- ```ggplot2``` : Plotting
- ```kableExtra```: Nice tables

** Testing Steps
- Create model using ```lmer``` function and the full model described above
- Run an ```anova()``` on the resulting object to determine if fixed factors are significant.
- Run an ```ranova()``` on object to see if random effects are significant.
  - If they are not significant then they can be removed from the model.
  
- Create a simple linear model without random effects using ```lm()```
- Test the random effects model against simple model using ```anova()``` function to determine if the model is improved by adding random effects.
  - If is isn't (and the random effects are not significant from previous analysis), than the simple model with be selected.

- Proceed to check the relative importance of the fixed factors (running models using either ```lmer``` or ```lm``` depending on whether you decide to keep random effects after the previous step.
- Use ```step()``` as an automated backup to confirm model selection

### Versions of Analysis

1) ANOVA with random effects on **complete** EPF pH Data.
  - PROS : This gives us the most complete look at oyster EPF response over the duration of the exposure
  - CONS : We don't have the complete carbonate chem and EPF pH is not a perfect proxie for calcite saturation, and may not capture what the oyster is actually doing to phenotypically mediate the effects of OA.
  
2) ANOVA with random effects on EPF pH data for only **samples we sequenced**.
  - PROs : (i) This provides use the most direct look at osyter EPF pH response in samples where we also have sequence data.
  - CONS :  (i) Still don't have complete carbon chem for all samples. 
  
3) ANOVA with random effects on EPF Calcite, ph, DIC on **samples with complete carbonate chemistry**.
  - PROS: Have complete chemistry
  - CONS: seriously small sample sizes (2 or 3 samples in some treatmentxtime levels)





